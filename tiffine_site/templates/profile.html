
{% extends 'base.html' %} 
{% block content %} 
{% load static %}

<link rel="stylesheet" href="{% static 'css/profile.css' %}" />

</head>
<body class="bg-info bg-opacity-10">
    <div class="container mt-3">
        <div class="d-flex justify-content-center">
            <div class="row">
                <div class="col">
                    <img class="d-flex img-responsive img-thumbnail" height="80px" width="80px" src="{% static 'images/user-icon.png' %}" alt="">
                </div>
            </div>
        </div>
        <div class="d-flex justify-content-center">
            <div class="row">
                <div class="col">
                    <h6><strong>Username :</strong> {{request.user}}</h6>
                </div>
            </div>
        </div>
        <div class="d-flex justify-content-center">
            <div class="row">
                <div class="col">
                    <h6><strong>Email : </strong> {{request.user.email}}</h6>
                </div>
            </div>
        </div>
        <div class="d-flex justify-content-center">
            <div class="row">
                <div class="col">
                    <h6><strong>Points :</strong> 15</h6>
                </div>
            </div>
        </div>
        <div class=" float-end">
            <a href="#" data-bs-toggle="modal" data-bs-target="#staticBackdrop" ><lord-icon
                src="https://cdn.lordicon.com/ryyjawhw.json"
                trigger="hover"
                colors="primary:#121331"
                state="hover-1"
                style="width:30px;height:30px">
            </lord-icon></a>
        </div>

        <!-- Modal -->
        <div class="modal fade " id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog ">
            <div class="modal-content modal-bg ">
                <div class="modal-header">
                <h5 class="modal-title text-light" id="staticBackdropLabel">Change password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="" id = 'passwd-form'>
                    <div class="modal-body">
                        <input type="password" class="form-control mb-2" id="current-passwd" placeholder="Current password">
                        <input type="password" class="form-control mb-2" id="passwd1" placeholder="Password">
                        <input type="password" class="form-control mb-2" id="passwd2" placeholder="Confirm password">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" id = "change-pass" class="btn btn-success">Change</button>
                    </div>
                </form>
            </div>
            </div>
        </div>
        
        <hr>
        <div class="row d-flex mb-2">

            <div class="col-md-4 col-sm-12 d-inline-block" id= "address-sec">

                <h4 class="text-success">Address
                    <a href="" class="float-end" data-bs-toggle="modal" data-bs-target="#address-add">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-plus-square-dotted" viewBox="0 0 16 16">
                            <path d="M2.5 0c-.166 0-.33.016-.487.048l.194.98A1.51 1.51 0 0 1 2.5 1h.458V0H2.5zm2.292 0h-.917v1h.917V0zm1.833 0h-.917v1h.917V0zm1.833 0h-.916v1h.916V0zm1.834 0h-.917v1h.917V0zm1.833 0h-.917v1h.917V0zM13.5 0h-.458v1h.458c.1 0 .199.01.293.029l.194-.981A2.51 2.51 0 0 0 13.5 0zm2.079 1.11a2.511 2.511 0 0 0-.69-.689l-.556.831c.164.11.305.251.415.415l.83-.556zM1.11.421a2.511 2.511 0 0 0-.689.69l.831.556c.11-.164.251-.305.415-.415L1.11.422zM16 2.5c0-.166-.016-.33-.048-.487l-.98.194c.018.094.028.192.028.293v.458h1V2.5zM.048 2.013A2.51 2.51 0 0 0 0 2.5v.458h1V2.5c0-.1.01-.199.029-.293l-.981-.194zM0 3.875v.917h1v-.917H0zm16 .917v-.917h-1v.917h1zM0 5.708v.917h1v-.917H0zm16 .917v-.917h-1v.917h1zM0 7.542v.916h1v-.916H0zm15 .916h1v-.916h-1v.916zM0 9.375v.917h1v-.917H0zm16 .917v-.917h-1v.917h1zm-16 .916v.917h1v-.917H0zm16 .917v-.917h-1v.917h1zm-16 .917v.458c0 .166.016.33.048.487l.98-.194A1.51 1.51 0 0 1 1 13.5v-.458H0zm16 .458v-.458h-1v.458c0 .1-.01.199-.029.293l.981.194c.032-.158.048-.32.048-.487zM.421 14.89c.183.272.417.506.69.689l.556-.831a1.51 1.51 0 0 1-.415-.415l-.83.556zm14.469.689c.272-.183.506-.417.689-.69l-.831-.556c-.11.164-.251.305-.415.415l.556.83zm-12.877.373c.158.032.32.048.487.048h.458v-1H2.5c-.1 0-.199-.01-.293-.029l-.194.981zM13.5 16c.166 0 .33-.016.487-.048l-.194-.98A1.51 1.51 0 0 1 13.5 15h-.458v1h.458zm-9.625 0h.917v-1h-.917v1zm1.833 0h.917v-1h-.917v1zm1.834-1v1h.916v-1h-.916zm1.833 1h.917v-1h-.917v1zm1.833 0h.917v-1h-.917v1zM8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3v-3z"/>
                        </svg>
                    </a>
                </h4>
                {% for addr_obj in address %}
                    <div class=" p-2 bg-light rounded-1 border p-1 mb-2" >
                        <p class="p-1">{{addr_obj.street}} ,{{addr_obj.city}},{{addr_obj.pincode}}  

                        <buttom class="float-end btn-edit" id="add-{{addr_obj.id}}" data-sid="{{addr_obj.id}}" data-bs-toggle="modal" data-bs-target="#address-add" data-bs-toggle="modal" data-bs-target="#address-add">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16">
                                <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                                <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/>
                            </svg>
                        </buttom>
                        <button  class="float-end btn-delete" id="add-{{addr_obj.id}}" data-sid="{{addr_obj.id}}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="red" class="bi bi-trash-fill" viewBox="0 0 16 16">
                                <path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z"/>
                            </svg>
                        </button>
                    </p>
                        
                    </div>
                {% empty %}
                    <p class="alert alert-info">Not found any address </p>
                
                {% endfor %}
            </div>

            <!-- Modal  for update address-->
            <div class="modal fade" id="address-add" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true" id="modal-close">
                <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                    <h5 class="modal-title" id="staticBackdropLabel">Adress Add/Edit</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                    <form action ="{% url 'sav_address' %}" method="POST" id="address-form">

                        {% csrf_token %}
                        <input type="hidden" name="address-id" id="hidden-id">
                        {{ add_form.as_p }}
                            
                    </div>
                    <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="close-btn">Cencel</button>
                    <button type="button" class="btn btn-primary" id = 'adding_addr' >Save</button>
                    </div>
                </form>
                </div>
                </div>
            </div>

            <div class="col-md-4 col-sm-12 d-inline-block">
                <h4 class="text-success">Order</h4>
                <div class="d-flex p-2 bg-light rounded-1 border p-1">
                    <p>chole chawal </p>
                </div>

                <div class="d-flex p-2 bg-light rounded-1 border p-1">
                    <p>chole chawal </p>
                </div>

                <div class="d-flex p-2 bg-light rounded-1 border p-1">
                    <p>chole chawal </p>
                </div>

            </div>
            <div class="col-md-4 col-sm-12 d-inline-block">
                <h4 class="text-success">Payment History</h4>
                <div class="d-flex p-2 bg-light rounded-1 border p-1">
                    <p><strong>Date :</strong> 25/02/2022 ,<strong> Amount :</strong> 250 </p>
                </div>
            </div>
        </div>
    </div>    
    <script src="https://cdn.lordicon.com/lusqsztk.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script>
        $('#change-pass').click(function(){
            let current_passwd = $("#current-passwd").val();
            const passwd1 = $('#passwd1').val();
            const passwd2 = $('#passwd2').val();

            datas = {
                password : current_passwd,
                new_passwd : passwd1,
                new_passwd2 : passwd2,
                csrfmiddlewaretoken: '{{ csrf_token }}',
            }
            $.ajaxSetup({ headers: { 'csrftoken' : '{{ csrf_token }}' } });
            $.ajax({
                url:"{% url 'change-pass' %}",
                method : 'POST',
                data : datas,
                dataType : "json",
                success: function(data){
                    if (data.status == 'done'){
                        // window.location('login/');
                        $('#staticBackdrop').modal('hide');
                    }
                    if (data.status == 'old passwor wrong'){
                        $('#passwd-form')[0].reset()
                    }
                    if (data.status == 'not matched'){
                        $('#passwd-form')[0].reset()
                    }
                }
            })
        })
        // insert data into the database
        $('#adding_addr').click(function(){
            
            let id = $('#hidden-id').val();
            let street = $('#street-id').val();
            let locality = $('#locality-id').val();
            let landmark = $('#landmark-id').val();
            let city = $('#city-id').val();
            let pincode = $('#pincode-id').val();

            datas = { csrfmiddlewaretoken: '{{ csrf_token }}',
                        id : id,
                        street : street,
                        locality : locality,
                        landmark : landmark,
                        city : city,
                        pincode : pincode,
                };

            $.ajaxSetup({ headers: { 'csrftoken' : '{{ csrf_token }}' } });
            $.ajax({
                url : "{% url 'sav_address' %}",
                method : 'POST',
                data : datas,
                dataType : "json",

                success: function(data){
                    var x = data.data_obj
                    for (i = 0; i < x.length; i ++){
                        output = ' <div class="d-flex p-2 bg-light rounded-1 border p-1 mb-2" > <p> ' + x[i].street + ',' + x[i].city + ',' + x[i].pincode + 
                            '</p></div>' 
                    };

                    $('#address-sec').html(output);
                    $('#hidden-id').val('');
                    $('#address-form')[0].reset();
                    $('#modal-close'). modal('hide');
                }
            })
        })

        // delete address objs
        $(".btn-delete").on('click', function(){
            let id = $(this).attr('data-sid')
            data = {
                sid : id,
                csrfmiddlewaretoken: '{{ csrf_token }}',
            }
            mythis = this
            $.ajaxSetup({ headers: { 'csrftoken' : '{{ csrf_token }}' } });
            $.ajax({
                url : "{% url 'delete-addr' %}",
                method : "POST",
                data : data,
                success : function(data){
                    if (data.status == 200){
                        $(mythis).closest('div').fadeOut()
                    }
                }

            })
        })

         // edit address objs
         $(".btn-edit").on('click', function(){
            let id = $(this).attr('data-sid')
            data = {
                sid : id,
                csrfmiddlewaretoken: '{{ csrf_token }}',
            }

            $.ajaxSetup({ headers: { 'csrftoken' : '{{ csrf_token }}' } });
            $.ajax({
                url : "{% url 'edit-addr' %}",
                method : "POST",
                data : data,
                success : function(data){
                    console.log(data)
                    $('#street-id').val(data.street)
                    $('#locality-id').val(data.locality)
                    $('#landmark-id').val(data.landmark)
                    $('#city-id').val(data.city)
                    $('#pincode-id').val(data.pincode)
                    $('#hidden-id').val(data.id)
                }


            })
        })
        
    </script>
</body>
{% endblock content %}

